<!DOCTYPE html>
<html>
<head><link rel="stylesheet" href="styles/main.css"/></head>
<title> Pronunciation Gym </title>
<body>
    <nav class="slidemenu">
        <!-- Item 1 -->
        <input type="radio" name="slideItem" id="slide-item-1" class="slide-toggle" checked/>
        <label for="slide-item-1"><span onclick="window.location.href='gymnastics';">Luyện Tập</span></label>

        <!-- Item 2 -->
        <input type="radio" name="slideItem" id="slide-item-2" class="slide-toggle"/>
        <label for="slide-item-2"><span onclick="window.location.href='statistics';">Thống Kê</span></label>

        <div class="clear"></div>
        <!-- Bar -->
        <div class="slider">
        <div class="bar"></div>
        </div>
    </nav>
    <div style="width: 100%; display: table; margin-top: 50px;">
        <div style="display: table-row;">
            <div align="center" style="width: 25%; display: table-cell; vertical-align: top;">
                <ul class="timer">
                    <li> 
                        <span class="hours">00</span>
                        <p class="hours_ref">hours</p>
                    </li>
                    <li class="seperator">:</li>
                    <li> 
                        <span class="minutes">00</span>
                        <p class="minutes_ref">minutes</p>
                    </li>
                    <li class="seperator">:</li>
                    <li> 
                        <span class="seconds">00</span>
                        <p class="seconds_ref">seconds</p>
                    </li>
                    <li class="seperator">.</li>
                    <li> 
                        <span class="milliseconds">000</span>
                        <p class="milliseconds_ref">milliseconds</p>
                    </li>
                </ul>
            </div>
            <div style="width: 50%; display: table-cell;"> 
                <span id="paragraph" class="paragraph" style="font-size: 200%; background: inherit;" ></span>
            </div>
            <div align="center" style="display: table-cell; " >
                <span id="ipa_span" class="ipa" style="font-size: 200%;">&nbsp</span></br>
                <span id="word_span" class="word" style="font-size: 200%;">&nbsp</span></br>
                <span id="interim_span" class="interim" style="font-size: 100%;">&nbsp</span>
                </br>
            </div>
        </div>
    </div>
    <div align="center" style="margin-top: 100px;">
        <div align="center" id="history" style="width: 900px; height: 500px;"></div>
    </div>
</body>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript" src="js/main.js"></script>
<script type="text/javascript">
// global variables
var user_id = -1;
var paragraph_id = -1;
var session_id = "";
var paragraph = "";
var curr_paragraph_indx = 0;
var last_curr_paragraph_indx = -1; 
var curr_interim_indx = 0;

var ipa_span = document.getElementById('ipa_span')
var word_span = document.getElementById('word_span')
var interim_span = document.getElementById('interim_span') 

var stopWatch = new StopWatch();
var started = setInterval(clockRunning, 10);
var final_sent_started_at = 0
var is_building_final_sent = false

// entry point to client-side logic
if (!('webkitSpeechRecognition' in window)) {
    upgrade();
} else {
    var recognition = new window.webkitSpeechRecognition;
    recognition.lang = "en-US"
    recognition.continuous = true;
    recognition.interimResults = true;

    startItAll()
}

async function startItAll() {
    user_id = await getUser();
    results = await getParagraphForUser(user_id);
    paragraph_id = results["paragraph_id"]
    paragraph = results["content"].split(" ");
    min_completion_time = results["min_completion_time"]
    session_id = generateRandomString(16);

    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawBarChart);

    reset();

    /*recognition.onaudiostart = function() {
        console.log("onaudiostart")
    }

    recognition.onaudioend = function() {
        console.log("onaudioend")
    }

    recognition.onspeechstart = function() {
        console.log("onspeechstart")
    }

    recognition.onspeechend = function() {
        console.log("onspeechend")
    }

    recognition.onsoundstart = function() {
        console.log("onsoundstart")
    }

    recognition.onsoundend = function() {
        console.log("onsoundend")
    }*/

    recognition.onend = function() {
        recognition.start()
    }

    recognition.onresult = function(event) {
        console.log(is_building_final_sent)
        if (!is_building_final_sent) {
            if (!document.hasFocus()) {
                return
            }
            is_building_final_sent = true
            final_sent_started_at = stopWatch.getTime()
            stopWatch.start();
        }

        transcript = ""
        isFinal = false
        for (var i = event.resultIndex; i < event.results.length; ++i) {
            isFinal |= event.results[i].isFinal;
            transcript += event.results[i][0].transcript;
        }
        
        words = transcript.trim().split(" ")
        i = curr_interim_indx
        while (i < words.length) {
            if ((curr_paragraph_indx < paragraph.length) && 
                (norm(words[i].toLowerCase()) == norm(paragraph[curr_paragraph_indx]))) {
                [duration, completed_at] = stopWatch.getDuration();

                logEvent(user_id, 
                         paragraph_id, 
                         session_id, 
                         curr_paragraph_indx, 
                         paragraph[curr_paragraph_indx], 
                         paragraph.length, 
                         duration, 
                         completed_at);

                curr_paragraph_indx += 1
                curr_interim_indx = i

                document.getElementById('paragraph').innerHTML = 
                    "<strong>" + paragraph.slice(0, curr_paragraph_indx).join(" ") + "</strong> " +
                    paragraph.slice(curr_paragraph_indx).join(" ");

                if (curr_paragraph_indx < paragraph.length) {
                    transcribe(paragraph[curr_paragraph_indx])
                }
            }
            i += 1
        }
        interim_span.innerHTML = words.slice(curr_interim_indx).join(" ")

        if (isFinal | (curr_paragraph_indx == paragraph.length)) {
            if (isFinal) {
                curr_interim_indx = 0
                interim_span.innerHTML = ""
            }

            completed_at = stopWatch.getTime()
            var word = "";
            if (curr_paragraph_indx == paragraph.length) {
                const ut = new SpeechSynthesisUtterance('Well done!');
                speechSynthesis.speak(ut);
                logFinalSent(user_id, 
                             paragraph_id, 
                             session_id, 
                             transcript, 
                             curr_paragraph_indx, 
                             word, 
                             final_sent_started_at, 
                             completed_at, 
                             drawBarChart)
                reset();
            } else {
                is_building_final_sent = false
                word = paragraph[curr_paragraph_indx]
                stopWatch.stop()
                logFinalSent(user_id, 
                             paragraph_id, 
                             session_id, 
                             transcript, 
                             curr_paragraph_indx, 
                             word, 
                             final_sent_started_at, 
                             completed_at)
            }
            
        }
    }

    recognition.start()    
}

function getUser() {
    return new Promise(function (resolve, reject) {
        if (!document.cookie) {
            var userName = generateRandomString(16)
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "create_user/" + userName, true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    var jsonContent = JSON.parse(xhr.responseText);            
                    document.cookie = userName + " " + jsonContent["user_id"]
                    resolve(jsonContent["user_id"])
                }
            }
            xhr.send();
        } else {
            resolve(document.cookie.split(" ")[1])
        }
    });
}

function getParagraphForUser(user_id) {
    return new Promise(function (resolve, reject) {
        var xhr = new XMLHttpRequest();
        xhr.open("POST", "get_paragraph_for_user/" + user_id, true);
        xhr.setRequestHeader("Content-Type", "application/json");

        xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var jsonContent = JSON.parse(xhr.responseText);
                resolve(jsonContent)
            }
        }
        xhr.send();   
    }) 
}

function transcribe(word) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "transcribe/" + word, true);
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            var jsonContent = JSON.parse(xhr.responseText);
            ipa_span.innerHTML = jsonContent["ipa"]
            word_span.innerHTML = norm(word)
        }
    }
    xhr.send();
}

function logEvent(user_id, paragraph_id, session_id, word_index, word, paragraph_length, duration, completed_at) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "event/", true);
    xhr.setRequestHeader("Content-Type", "application/json");

    var data = JSON.stringify({"user_id": user_id, 
                               "paragraph_id": paragraph_id, 
                               "session_id": session_id, 
                               "word_index": word_index, 
                               "word": word, 
                               "paragraph_length": paragraph_length,
                               "duration": duration, 
                               "completed_at": completed_at})
    xhr.send(data);
}

function logFinalSent(user_id, paragraph_id, session_id, sentence, word_index, word, started_at, completed_at, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "final_sent/", true);
    xhr.setRequestHeader("Content-Type", "application/json");

    var data = JSON.stringify({"user_id": user_id, 
                               "session_id": session_id, 
                               "paragraph_id": paragraph_id, 
                               "sentence": sentence, 
                               "word_index": word_index, 
                               "word": word, 
                               "started_at": started_at,
                               "completed_at": completed_at})
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            if (callback) {
                console.log("asfasdfsadf")
               callback()
            }
        }
    }
    xhr.send(data);
}

function norm(word) {
    word = word.toLowerCase().replace(/[\.,\"'’]/mg, "")
    if (word.slice(-1) === "s") {
        word = word.slice(0, -1)
    }
    return word
}

function readit() {
    if (curr_paragraph_indx < paragraph.length) {
        var msg = new SpeechSynthesisUtterance(norm(paragraph[curr_paragraph_indx]));
        window.speechSynthesis.speak(msg);
    }
}

function clockRunning(){
    var timeElapsed = new Date(stopWatch.getTime())
    var hour = timeElapsed.getUTCHours()
    , min = timeElapsed.getUTCMinutes()
    , sec = timeElapsed.getUTCSeconds()
    , ms = timeElapsed.getUTCMilliseconds();

    document.getElementsByClassName("hours")[0].innerHTML = hour > 9 ? hour : "0" + hour
    document.getElementsByClassName("minutes")[0].innerHTML = min > 9 ? min : "0" + min
    document.getElementsByClassName("seconds")[0].innerHTML = sec > 9 ? sec : "0" + sec
    document.getElementsByClassName("milliseconds")[0].innerHTML = ms > 99 ? ms : ms > 9 ? "0" + ms : "00" + ms
};

function reset(){
    is_building_final_sent = false
    last_curr_paragraph_indx = -1
    curr_paragraph_indx = 0;
    transcribe(paragraph[curr_paragraph_indx])
    session_id = generateRandomString(16);

    document.getElementById('paragraph').innerHTML = paragraph.join(" ")
    transcribe(paragraph[0])

    stopWatch = new StopWatch();
    started = setInterval(clockRunning, 100);  
}

function generateRandomString(length) {
    var result = Date.now().toString(36)
    for ( var i = 0; i < 8; i++ ) {
        result += Math.floor(Math.random() * 36).toString(36)
    }
    return result;
}

function drawBarChart() {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "get_history/" + String(user_id) + "/" + String(paragraph_id), true);
    xhr.setRequestHeader("Content-Type", "application/json");

    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            var jsonContent = JSON.parse(xhr.responseText);
            console.log(jsonContent)

            if (jsonContent.length == 0) {
                return
            }
            
            rows = [['Time', 'Duration', 'Record Time']]
            for (var i = 0; i < jsonContent.length; ++i) {
                row = jsonContent[i]
                rows.push([String(i+1), row["duration"]/1000, min_completion_time/1000])
            }

            var data = new google.visualization.arrayToDataTable(rows);

            var options = {
                title: 'Lịch Sử Luyện Tập',
                seriesType: 'bars',
                series: {
                    0: {
                        type: "bar"
                    },
                    1: {
                        type: 'line',
                        lineDashStyle: [3, 4]
                    },
                },
                vAxis: {
                    viewWindow: {
                        min: 0
                    }
                }
            }

            var chart = new google.visualization.ComboChart(document.getElementById('history'));
            chart.draw(data,options);
        }
    }
    xhr.send();
}

document.addEventListener("keypress", function(e) {
    if (e.keyCode == 32) {
        readit();
    }
});

document.addEventListener("keypress", function(e) {
    if (e.keyCode == 13) {
        reset();
    }
});
</script>
</html>
